<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#050505">
    <title>Khalifa Commander V12</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg: #050505;
            --card-bg: #141414;
            --text: #fff;
            --muted: #888;
            
            /* EXTREME GRADIENTS */
            --p1-grad: linear-gradient(135deg, #ff2c2c, #ff6b30);
            --p2-grad: linear-gradient(135deg, #ff8800, #ffbb00);
            --p3-grad: linear-gradient(135deg, #007aff, #00d4ff);
            --p46-grad: linear-gradient(135deg, #7b1fa2, #e040fb);
            
            --gold: #ffd700;
            --nav-height: 80px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 0;
            padding-top: 140px; 
            padding-bottom: 100px;
            overscroll-behavior-y: none;
        }

        /* --- HEADER --- */
        .fixed-header {
            position: fixed; top: 0; left: 0; right: 0;
            background: rgba(5,5,5,0.96); backdrop-filter: blur(10px);
            z-index: 100; border-bottom: 1px solid #222;
        }
        
        .top-deck {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 20px; height: 90px;
        }

        .clock-area h1 { margin: 0; font-size: 1.8rem; font-weight: 800; letter-spacing: -1px; }
        .clock-area p { margin: 0; font-size: 0.7rem; color: var(--muted); text-transform: uppercase; font-weight: 700; letter-spacing: 1px; }

        .header-right { display: flex; align-items: center; gap: 15px; }

        /* RINGS */
        .rings-wrapper { display: flex; gap: 10px; }
        .ring-box { position: relative; width: 50px; height: 50px; }
        .ring-svg { transform: rotate(-90deg); width: 50px; height: 50px; }
        .ring-bg { fill: none; stroke: #222; stroke-width: 4; }
        .ring-val { fill: none; stroke-width: 4; stroke-linecap: round; stroke-dasharray: 126; stroke-dashoffset: 126; transition: stroke-dashoffset 1s, stroke 0.5s; }
        .ring-icon { position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:0.9rem; }

        /* HAMBURGER */
        .menu-btn { background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; padding: 5px; }

        /* FILTER BAR */
        .filter-bar {
            display: flex; gap: 10px; padding: 0 20px 15px 20px;
            overflow-x: auto;
        }
        .filter-pill {
            background: #1a1a1a; border: 1px solid #333; color: #888;
            padding: 6px 14px; border-radius: 20px; font-size: 0.75rem; font-weight: 700;
            white-space: nowrap; transition: all 0.2s;
        }
        .filter-pill.active { background: #fff; color: #000; }

        /* --- DASHBOARD SUMMARY CARD --- */
        .summary-card {
            background: linear-gradient(180deg, #181818, #0a0a0a);
            margin: 20px 20px 30px 20px; padding: 15px; border-radius: 16px; border: 1px solid #2a2a2a;
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; text-align: center;
        }
        .sum-val { font-size: 1.2rem; font-weight: 800; display: block; color: #fff; }
        .sum-label { font-size: 0.6rem; color: #666; text-transform: uppercase; font-weight: 700; }
        .sum-sep { width: 1px; background: #222; height: 30px; margin: auto; }

        /* --- TASK CARDS --- */
        .zone-header {
            margin: 30px 20px 10px 20px; 
            display: flex; justify-content: space-between; align-items: flex-end;
            padding-bottom: 5px; border-bottom: 1px solid #222;
        }
        .zone-title { font-size: 0.8rem; font-weight: 900; color: #fff; text-transform: uppercase; letter-spacing: 0.5px; }
        .zone-stats { font-size: 0.75rem; font-family: monospace; color: #666; }

        .task-card {
            background: var(--card-bg); margin: 0 20px 15px 20px; padding: 18px;
            border-radius: 16px; border: 1px solid #222;
            position: relative; overflow: hidden; transition: transform 0.1s;
        }
        .task-card:active { transform: scale(0.98); }

        /* THE CHARGING ANIMATION */
        .task-card.pressing { transform: scale(0.95); transition: transform 1.2s cubic-bezier(0.2, 0.8, 0.2, 1); }

        /* GRADIENT BORDERS */
        .prio-1 { border-left: 4px solid #ff2c2c; }
        .prio-2 { border-left: 4px solid #ff8800; }
        .prio-3 { border-left: 4px solid #007aff; }
        .prio-low { border-left: 4px solid #7b1fa2; opacity: 0.9; }

        /* STATES */
        .recording { background: #1a0a0a; border-color: #ff3b30; box-shadow: 0 0 20px rgba(255,59,48,0.1); }
        .paused { background: #1a1505; border-color: #ffb74d; animation: pulseYellow 3s infinite; }
        .done .task-title { color: var(--gold); }
        
        @keyframes pulseYellow { 0% { border-color: #ffb74d; } 50% { border-color: #554010; } 100% { border-color: #ffb74d; } }

        /* CARD CONTENT */
        .card-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .task-title { font-size: 1rem; font-weight: 700; display: block; margin-bottom: 3px; }
        .task-meta { font-size: 0.75rem; color: #666; display: flex; gap: 8px; }
        
        /* CONTROLS */
        .control-group { display: flex; align-items: center; gap: 10px; }
        
        .badge-container { display: flex; flex-direction: column; align-items: flex-end; }
        .timer-badge { 
            font-family: monospace; font-size: 0.85rem; color: #555; background: #000; 
            padding: 6px 10px; border-radius: 6px; min-width: 65px; text-align: center; 
        }
        .pending-text { font-size: 0.65rem; color: #ffb74d; margin-top: 2px; font-weight: bold; }

        .recording .timer-badge { color: #fff; background: #d32f2f; }
        .paused .timer-badge { color: #000; background: #ffb74d; }

        .btn-main {
            width: 50px; height: 50px; border-radius: 50%; border: none;
            background: #252525; color: #fff; font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: all 0.2s;
        }
        .btn-stop {
            width: 35px; height: 35px; border-radius: 50%; border: none;
            background: #222; color: #ff2c2c; font-size: 0.9rem;
            display: none; align-items: center; justify-content: center;
        }

        /* DYNAMIC COLORS */
        .prio-1 .recording .btn-main { background: var(--p1-grad); }
        .prio-2 .recording .btn-main { background: var(--p2-grad); }
        .prio-3 .recording .btn-main { background: var(--p3-grad); }
        .prio-low .recording .btn-main { background: var(--p46-grad); }
        
        .paused .btn-main { background: #ffb74d !important; color: #000; }

        .recording .btn-stop, .paused .btn-stop { display: flex; }

        /* Progress Bar */
        .card-progress-bg { height: 4px; background: #222; border-radius: 2px; overflow: hidden; margin-top: 10px; }
        .card-progress-fill { height: 100%; background: #444; width: 0%; transition: width 0.5s; }
        
        .prio-1 .card-progress-fill { background: var(--p1-grad); }
        .prio-2 .card-progress-fill { background: var(--p2-grad); }
        .prio-3 .card-progress-fill { background: var(--p3-grad); }
        .prio-low .card-progress-fill { background: var(--p46-grad); }
        .done .card-progress-fill { background: var(--gold) !important; }

        /* --- STATS VIEW --- */
        .view-section { display: none; padding: 0 20px 20px 20px; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }
        
        .chart-container { display: flex; justify-content: space-between; align-items: flex-end; height: 150px; margin: 20px 0; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .chart-col { display: flex; flex-direction: column; align-items: center; width: 12%; }
        .chart-bar { width: 100%; background: #333; border-radius: 4px 4px 0 0; transition: height 0.5s; min-height: 2px; }
        .chart-day { font-size: 0.6rem; color: #666; margin-top: 5px; }

        .dist-bar { display: flex; align-items: center; margin-bottom: 15px; }
        .dist-label { width: 80px; font-size: 0.75rem; color: #aaa; font-weight: bold; }
        .dist-track { flex-grow: 1; height: 24px; background: #222; border-radius: 4px; margin: 0 10px; position: relative; overflow: hidden; }
        .dist-fill { height: 100%; border-radius: 4px; display: flex; align-items: center; padding-left: 8px; font-size: 0.7rem; color: #fff; text-shadow: 0 0 2px rgba(0,0,0,0.5); font-weight: bold; width: 0%; transition: width 0.5s;}
        
        /* --- BOTTOM NAV --- */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; right: 0; height: 80px;
            background: #000; border-top: 1px solid #1a1a1a;
            display: grid; grid-template-columns: 1fr 1fr;
            z-index: 150;
        }
        .nav-btn {
            background: none; border: none; color: #555;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 0.75rem; gap: 6px; font-weight: 700;
        }
        .nav-btn.active { color: #fff; }
        .nav-btn i { font-size: 1.4rem; }

        /* --- OVERLAYS --- */
        .toast {
            position: fixed; bottom: 90px; left: 20px; right: 20px;
            background: #222; border: 1px solid #333; color: #fff;
            padding: 15px; border-radius: 10px;
            display: flex; justify-content: space-between; align-items: center;
            transform: translateY(150%); transition: transform 0.3s; z-index: 200;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .toast.show { transform: translateY(0); }
        .btn-undo { background: none; border: 1px solid #555; color: #fff; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; }
        .toast-msg { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }

        /* SETTINGS MODAL */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:300; align-items:center; justify-content:center; }
        .modal-content { background:#222; padding:25px; border-radius:15px; width:85%; text-align:center; border: 1px solid #444; }
        .modal-btn { width:100%; padding:15px; background:#333; border:none; color:#fff; border-radius:8px; margin-bottom:10px; font-weight:bold; font-size: 1rem; }
        .slider-container { margin: 20px 0; text-align: left; }
        input[type=range] { width: 100%; margin-top: 10px; }
        
        #confetti { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }

        @keyframes pulseYellow { 0% { border-color: #ffb74d; } 50% { border-color: #554010; } 100% { border-color: #ffb74d; } }
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }

    </style>
</head>
<body>

    <canvas id="confetti"></canvas>

    <!-- HEADER -->
    <div class="fixed-header">
        <div class="top-deck">
            <div class="clock-area">
                <h1 id="clock">07:00</h1>
                <p>COMMANDER V12</p>
            </div>
            
            <div class="header-right">
                <div class="rings-wrapper">
                    <!-- Ring 1: Tid (17h) -->
                    <div class="ring-box">
                        <svg class="ring-svg" viewBox="0 0 50 50">
                            <circle class="ring-bg" cx="25" cy="25" r="20"></circle>
                            <circle id="ring-day" class="ring-val" cx="25" cy="25" r="20" stroke="#666"></circle>
                        </svg>
                        <div class="ring-icon">üïí</div>
                    </div>
                    <!-- Ring 2: Budget -->
                    <div class="ring-box">
                        <svg class="ring-svg" viewBox="0 0 50 50">
                            <circle class="ring-bg" cx="25" cy="25" r="20"></circle>
                            <circle id="ring-budget" class="ring-val" cx="25" cy="25" r="20" stroke="#ff8800"></circle>
                        </svg>
                        <div class="ring-icon">üî•</div>
                    </div>
                </div>
                <button class="menu-btn" onclick="openSettings()"><i class="fas fa-bars"></i></button>
            </div>
        </div>

        <div class="filter-bar">
            <div class="filter-pill active" onclick="setFilter('today', this)">IDAG</div>
            <div class="filter-pill" onclick="setFilter('all', this)">ALLA</div>
            <div class="filter-pill" onclick="setFilter('todo', this)">G√ñRA</div>
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <div id="view-today" class="view-section active">
        <!-- FIXED SUMMARY CARD -->
        <div class="summary-card">
            <div>
                <span class="sum-val" id="sum-time">0h 0m</span>
                <span class="sum-label">Totalt Idag</span>
            </div>
            <div class="sum-sep"></div>
            <div>
                <span class="sum-val" id="sum-tasks">0/0</span>
                <span class="sum-label">Klara M√•l</span>
            </div>
            <div class="sum-sep"></div>
            <div>
                <span class="sum-val" id="sum-eff">0%</span>
                <span class="sum-label">Av Dagens M√•l</span>
            </div>
        </div>

        <div id="task-list"></div>
    </div>

    <!-- STATS VIEW -->
    <div id="view-stats" class="view-section">
        <h2>Veckans √ñversikt</h2>
        <div id="week-chart" class="chart-container"></div>
        
        <h2>Prio F√∂rdelning</h2>
        <div id="prio-breakdown"></div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="modal-settings" class="modal" onclick="if(event.target===this) this.style.display='none'">
        <div class="modal-content">
            <h3>Inst√§llningar</h3>
            
            <div class="slider-container">
                <label style="color:#aaa; font-size:0.9rem;">Dagens M√•l: <span id="goal-display" style="color:#fff; font-weight:bold;">14h</span></label>
                <input type="range" id="goal-slider" min="60" max="1020" step="30" oninput="updateGoal(this.value)">
            </div>

            <button class="modal-btn" onclick="exportData()"><i class="fas fa-download"></i> Exportera Data</button>
            <button class="modal-btn" onclick="document.getElementById('file-input').click()"><i class="fas fa-upload"></i> Importera Data</button>
            <input type="file" id="file-input" style="display:none" onchange="importData(this)">
            
            <button class="modal-btn" style="background:#8b0000; margin-top:20px;" onclick="confirmReset()">
                <i class="fas fa-exclamation-triangle"></i> Nollst√§ll Dagens Data
            </button>

            <button class="modal-btn" style="background:#444; margin-top:10px;" onclick="document.getElementById('modal-settings').style.display='none'">St√§ng</button>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="toast">
        <span class="toast-msg"><i class="fas fa-info-circle"></i> Meddelande</span>
        <button id="toast-undo-btn" class="btn-undo" onclick="undoLast()">√ÖNGRA</button>
    </div>

    <!-- BOTTOM NAV -->
    <div class="nav-bar">
        <button class="nav-btn active" onclick="switchView('today', this)"><i class="fas fa-bolt"></i>FOKUS</button>
        <button class="nav-btn" onclick="switchView('stats', this)"><i class="fas fa-chart-bar"></i>STATISTIK</button>
    </div>

<script>
    // --- KONFIGURATION ---
    const projects = [
        { id: 'yt_long', title: 'YouTube L√•ng', icon: 'üìπ', prio: 1, target: 120 },
        { id: 'yt_short', title: 'YouTube Kort', icon: 'üì±', prio: 1, target: 60 },
        { id: 'social', title: 'Social Media', icon: 'üí¨', prio: 2, target: 45 },
        { id: 'fam_act', title: 'Familj & Lek', icon: 'üé≤', prio: 2, target: 60 },
        { id: 'azzah', title: 'Azzah Tid', icon: '‚ù§Ô∏è', prio: 2, target: 60 },
        { id: 'kids', title: 'Barn 1-mot-1', icon: 'üë∂', prio: 2, target: 30 },
        { id: 'health', title: 'H√§lsa', icon: 'üåø', prio: 2, target: 45 },
        { id: 'prayer', title: 'B√∂n & Adhkar', icon: 'üìø', prio: 3, target: 30 },
        { id: 'meals', title: 'Mat & Hus', icon: 'üè†', prio: 3, target: 45 },
        { id: 'learning', title: 'L√§rande', icon: 'üß†', prio: 3, target: 30 },
        { id: 'thriller', title: 'Bok: Deckare', icon: 'üïµÔ∏è‚Äç‚ôÇÔ∏è', prio: 4, target: 30 },
        { id: 'biz', title: 'Business', icon: 'üíº', prio: 4, target: 30 },
        { id: 'prep', title: 'Meal Prep', icon: 'ü•¶', prio: 4, target: 60 },
        { id: 'coach', title: 'Coaching', icon: 'üéì', prio: 5, target: 30 },
        { id: 'strategy', title: 'Strategi', icon: '‚ôüÔ∏è', prio: 6, target: 30 },
        { id: 'ai', title: 'AI & Tech', icon: 'ü§ñ', prio: 6, target: 30 }
    ];

    const WAKE_TIME = 7; 
    const SLEEP_TIME = 24;

    // --- STATE MANAGER ---
    let history = JSON.parse(localStorage.getItem('khalifa_v12_hist')) || {};
    let sessions = JSON.parse(localStorage.getItem('khalifa_v12_sessions')) || {};
    let workGoal = parseInt(localStorage.getItem('khalifa_v12_goal')) || 840; 
    let undoStack = JSON.parse(localStorage.getItem('khalifa_v12_undo')) || [];
    const MAX_UNDO = 10;
    
    let filterMode = 'today';
    let cachedStreaks = {}; 

    // --- CORE ---
    function getTodayStr() { return new Date().toISOString().split('T')[0]; }
    function getTodayData() { 
        const d = getTodayStr();
        if(!history[d]) history[d] = {};
        return history[d];
    }
    function saveState() {
        localStorage.setItem('khalifa_v12_hist', JSON.stringify(history));
        localStorage.setItem('khalifa_v12_sessions', JSON.stringify(sessions));
        localStorage.setItem('khalifa_v12_goal', workGoal);
        localStorage.setItem('khalifa_v12_undo', JSON.stringify(undoStack));
    }
    function vibrate(ms) { if(navigator.vibrate) navigator.vibrate(ms); }

    // --- STREAK OPTIMIZATION ---
    function updateStreaks() {
        cachedStreaks = {};
        projects.forEach(p => {
            let s = 0;
            for(let i=1; i<30; i++) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const ds = d.toISOString().split('T')[0];
                if(history[ds] && history[ds][p.id] > 10) s++;
                else break;
            }
            cachedStreaks[p.id] = s;
        });
    }

    // --- RENDER ENGINE ---
    function render() {
        if(Object.keys(cachedStreaks).length === 0) updateStreaks();
        renderList();
        renderSummary();
        updateRings();
    }

    function renderList() {
        const list = document.getElementById('task-list');
        list.innerHTML = '';
        const todayData = getTodayData();

        // 1. Gruppera f√∂r Headers
        let zoneStats = { 1:{done:0, target:0}, 2:{done:0, target:0}, 3:{done:0, target:0}, 4:{done:0, target:0} };
        projects.forEach(p => {
            const z = p.prio > 3 ? 4 : p.prio;
            zoneStats[z].target += p.target;
            zoneStats[z].done += (todayData[p.id] || 0);
        });

        const sorted = [...projects].sort((a,b) => a.prio - b.prio);
        let lastPrio = 0;

        sorted.forEach(p => {
            if(filterMode === 'today' && p.prio > 3) return;
            if(filterMode === 'todo' && (todayData[p.id] || 0) >= p.target) return;

            // RENDER ZONE HEADER
            if(p.prio !== lastPrio) {
                let z = p.prio > 3 ? 4 : p.prio;
                let label = "FRAMTID";
                let icon = "üöÄ";
                if(z===1) { label="TUNG ZON"; icon="üî•"; }
                if(z===2) { label="BALANS"; icon="‚öñÔ∏è"; }
                if(z===3) { label="GRUND"; icon="‚öìÔ∏è"; }

                const doneH = formatTimeShort(zoneStats[z].done);
                const targH = formatTimeShort(zoneStats[z].target);

                list.innerHTML += `
                    <div class="zone-header">
                        <span class="zone-title">${icon} ${label}</span>
                        <span class="zone-stats">${doneH} / ${targH}</span>
                    </div>`;
                lastPrio = p.prio;
            }

            // CALC DATA
            const totalMins = todayData[p.id] || 0; // Committed history
            const session = sessions[p.id]; // Active/Paused session
            
            const isRunning = session && session.state === 'running';
            const isPaused = session && session.state === 'paused';
            
            // Calculate pending time (buffer)
            let pendingMins = 0;
            if (session) {
                if (isRunning) {
                    const elapsed = Date.now() - session.startTime;
                    pendingMins = Math.floor((session.accumulated + elapsed) / 60000);
                } else {
                    pendingMins = Math.floor(session.accumulated / 60000);
                }
            }

            const combinedMins = totalMins + pendingMins;
            const progressPct = Math.min(100, (combinedMins / p.target) * 100);
            
            const isDone = combinedMins >= p.target;
            const streak = cachedStreaks[p.id] || 0;

            // CLASSES
            let classes = 'task-card';
            if(p.prio === 1) classes += ' prio-1';
            else if(p.prio === 2) classes += ' prio-2';
            else if(p.prio === 3) classes += ' prio-3';
            else classes += ' prio-low';

            if(isRunning) classes += ' recording';
            if(isPaused) classes += ' paused';
            if(isDone && !isRunning) classes += ' done';

            // ICONS & TEXT
            let btnIcon = isRunning ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
            let timeTxt = formatTime(totalMins);
            let pendingTxt = "";

            if(isRunning) {
                timeTxt = "REC...";
            } else if(isPaused && pendingMins > 0) {
                pendingTxt = `+${pendingMins}m P√ÖG√ÖR`;
            }

            const streakHtml = streak > 0 ? `<span style="color:#ff9800; font-size:0.7rem; margin-left:5px;">üî• ${streak}</span>` : '';

            const html = `
                <div class="${classes}" id="card-${p.id}" 
                     oncontextmenu="return false;" 
                     ontouchstart="startLongPress('${p.id}', event)" 
                     ontouchmove="trackMovement(event)"
                     ontouchend="cancelLongPress()"
                     onmousedown="startLongPress('${p.id}', event)" 
                     onmousemove="trackMovement(event)"
                     onmouseup="cancelLongPress()">
                     
                    <div class="card-top">
                        <div style="flex-grow:1">
                            <span class="task-title">${p.icon} ${p.title}</span>
                            <div class="task-meta">M√•l: ${p.target}m ${streakHtml}</div>
                        </div>
                        <div class="control-group">
                            <div class="badge-container">
                                <div class="timer-badge" id="badge-${p.id}">${timeTxt}</div>
                                <div class="pending-text" id="pending-${p.id}">${pendingTxt}</div>
                            </div>
                            <button class="btn-stop" onclick="stopTask('${p.id}', event)"><i class="fas fa-stop"></i></button>
                            <button class="btn-main" onclick="toggleTask('${p.id}', event)">${btnIcon}</button>
                        </div>
                    </div>
                    <div class="card-progress-bg">
                        <div class="card-progress-fill" style="width:${progressPct}%"></div>
                    </div>
                </div>
            `;
            list.innerHTML += html;
        });
    }

    // --- SUMMARY CARD ---
    function renderSummary() {
        const d = getTodayData();
        let total = 0, doneCount = 0;
        
        projects.forEach(p => {
            let m = d[p.id] || 0;
            // L√§gg till p√•g√•ende sessions i totalen
            if(sessions[p.id]) {
                if(sessions[p.id].state === 'running') {
                    const elapsed = Date.now() - sessions[p.id].startTime;
                    m += Math.floor((sessions[p.id].accumulated + elapsed) / 60000);
                } else {
                    m += Math.floor(sessions[p.id].accumulated / 60000);
                }
            }
            
            total += m;
            if(m >= p.target) doneCount++;
        });

        document.getElementById('sum-time').innerText = formatTime(total);
        document.getElementById('sum-tasks').innerText = `${doneCount}/${projects.length}`;
        const eff = workGoal > 0 ? Math.round((total/workGoal)*100) : 0;
        document.getElementById('sum-eff').innerText = `${eff}%`;
    }

    // --- RINGS ---
    function updateRings() {
        const h = new Date().getHours() + new Date().getMinutes()/60;
        const dayPct = Math.max(0, Math.min(1, (h - WAKE_TIME)/(SLEEP_TIME - WAKE_TIME)));
        setRing('ring-day', dayPct, '#666');

        const d = getTodayData();
        let total = 0;
        projects.filter(p => p.prio <= 3).forEach(p => {
            let m = d[p.id] || 0;
            if(sessions[p.id]) {
                if(sessions[p.id].state === 'running') {
                    const elapsed = Date.now() - sessions[p.id].startTime;
                    m += Math.floor((sessions[p.id].accumulated + elapsed) / 60000);
                } else {
                    m += Math.floor(sessions[p.id].accumulated / 60000);
                }
            }
            total += m;
        });
        
        const budgetPct = workGoal > 0 ? total/workGoal : 0;
        const color = budgetPct >= 1 ? 'var(--gold)' : '#ff8800';
        setRing('ring-budget', budgetPct, color);
    }

    function setRing(id, pct, color) {
        const circle = document.getElementById(id);
        const r = circle.r.baseVal.value;
        const c = r * 2 * Math.PI;
        circle.style.strokeDashoffset = c - (pct * c);
        circle.style.stroke = color;
    }

    // --- MULTI-SESSION LOGIC ---
    function toggleTask(id, e) {
        if(e) e.stopPropagation();
        vibrate(20);
        const now = Date.now();
        
        if (sessions[id]) {
            if (sessions[id].state === 'running') {
                // PAUSA DETTA PROJEKT (P√•verkar ej andra)
                sessions[id].accumulated += (now - sessions[id].startTime);
                sessions[id].state = 'paused';
                sessions[id].startTime = null;
            } else if (sessions[id].state === 'paused') {
                // FORTS√ÑTT DETTA PROJEKT
                sessions[id].state = 'running';
                sessions[id].startTime = now;
            }
        } else {
            // NY SESSION
            sessions[id] = { accumulated: 0, state: 'running', startTime: now };
        }
        
        saveState();
        render();
    }

    function stopTask(id, e) {
        if(e) e.stopPropagation();
        vibrate(40);
        
        if(!sessions[id]) return;
        
        // R√§kna ut slutgiltig tid
        let finalSession = 0;
        if(sessions[id].state === 'running') {
            finalSession = Date.now() - sessions[id].startTime;
        }
        
        const totalMs = sessions[id].accumulated + finalSession;
        const mins = Math.floor(totalMs / 60000);
        
        // Commit om > 0
        if(mins > 0) commitTime(id, mins);
        
        // RADERA SESSIONEN
        delete sessions[id];
        
        saveState();
        render();
    }

    function commitTime(id, mins) {
        const d = getTodayStr();
        const oldTotal = history[d][id] || 0;
        
        if(!history[d]) history[d] = {};
        if(!history[d][id]) history[d][id] = 0;
        history[d][id] += mins;
        
        // Confetti check
        const p = projects.find(x => x.id === id);
        const newTotal = history[d][id];
        if(oldTotal < p.target && newTotal >= p.target) {
            setTimeout(triggerConfetti, 500);
            vibrate([100, 50, 100]);
        }

        // UNDO STACK
        undoStack.push({ date: d, id: id, mins: mins, timestamp: Date.now() });
        if(undoStack.length > MAX_UNDO) undoStack.shift();

        showToast(`üíæ ${mins}m sparad.`, true);
        saveState();
    }

    // --- SECURE LONG PRESS +5 ---
    let pressTimer;
    let pressStartX = 0, pressStartY = 0, hasMoved = false;

    function startLongPress(id, e) {
        if(e.touches) {
            pressStartX = e.touches[0].clientX;
            pressStartY = e.touches[0].clientY;
        } else {
            pressStartX = e.clientX;
            pressStartY = e.clientY;
        }
        hasMoved = false;
        
        const card = document.getElementById(`card-${id}`);
        card.classList.add('pressing');
        
        pressTimer = setTimeout(() => {
            if(!hasMoved) {
                vibrate(100);
                commitTime(id, 5);
                card.classList.remove('pressing'); 
                showToast("‚ö° +5 minuter tillagt!", true);
                render();
            }
        }, 1200); // 1.2 sec
    }
    
    function trackMovement(e) {
        let curX, curY;
        if(e.touches) {
            curX = e.touches[0].clientX;
            curY = e.touches[0].clientY;
        } else {
            curX = e.clientX;
            curY = e.clientY;
        }
        if(Math.abs(curX - pressStartX) > 10 || Math.abs(curY - pressStartY) > 10) {
            hasMoved = true;
            cancelLongPress();
        }
    }
    
    function cancelLongPress() { 
        clearTimeout(pressTimer);
        document.querySelectorAll('.task-card').forEach(c => c.classList.remove('pressing'));
    }

    // --- UNDO SYSTEM ---
    function undoLast() {
        if(undoStack.length === 0) return;
        
        const action = undoStack.pop();
        history[action.date][action.id] -= action.mins;
        if(history[action.date][action.id] < 0) history[action.date][action.id] = 0;
        
        saveState();
        document.getElementById('toast').classList.remove('show');
        
        // Uppdatera toast om fler finns
        if(undoStack.length > 0) {
            setTimeout(() => {
                showToast(`Tid √•ngrad. ${undoStack.length} kvar.`, true);
            }, 300);
        }
        
        render();
    }
    
    function confirmReset() {
        if(confirm("‚ö†Ô∏è VARNING: Detta raderar ALL dagens data (committed och timers). G√•r INTE att √•ngra. Forts√§tta?")) {
            const d = getTodayStr();
            if(history[d]) delete history[d];
            sessions = {};
            undoStack = [];
            saveState();
            render();
            document.getElementById('modal-settings').style.display='none';
            showToast("üîÑ Dagen nollst√§lld.", false);
        }
    }

    // --- LIVE LOOP ---
    setInterval(() => {
        const now = new Date();
        document.getElementById('clock').innerText = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        
        // Uppdatera alla RUNNING sessions
        Object.keys(sessions).forEach(id => {
            if(sessions[id].state === 'running') {
                const ms = sessions[id].accumulated + (Date.now() - sessions[id].startTime);
                const totalSec = Math.floor(ms/1000);
                const txt = `${Math.floor(totalSec/60)}:${String(totalSec%60).padStart(2,'0')}`;
                
                const badge = document.getElementById(`badge-${id}`);
                if(badge) badge.innerText = txt;
            }
        });
    }, 1000);

    // --- STANDARD FUNCTIONS (Stats, Settings, Utils) ---
    
    function updateGoal(val) {
        workGoal = parseInt(val);
        document.getElementById('goal-display').innerText = formatTime(workGoal);
        saveState();
        renderSummary();
        updateRings();
    }
    
    function openSettings() {
        document.getElementById('modal-settings').style.display='flex';
        document.getElementById('goal-slider').value = workGoal;
        document.getElementById('goal-display').innerText = formatTime(workGoal);
    }

    function showToast(msg, allowUndo) {
        const t = document.getElementById('toast');
        t.querySelector('.toast-msg').innerHTML = msg;
        const uBtn = document.getElementById('toast-undo-btn');
        
        if(allowUndo) {
            uBtn.style.display = 'block';
            uBtn.innerText = undoStack.length > 0 ? `√ÖNGRA (${undoStack.length})` : '√ÖNGRA';
        } else {
            uBtn.style.display = 'none';
        }

        t.classList.add('show');
        setTimeout(()=>t.classList.remove('show'), 4000);
    }

    function renderStats() {
        const cont = document.getElementById('week-chart');
        cont.innerHTML = '';
        const days = ['S√∂n','M√•n','Tis','Ons','Tor','Fre','L√∂r'];
        let max = 1;
        let weekData = [];
        let dist = {1:0, 2:0, 3:0, 4:0};

        for(let i=6; i>=0; i--) {
            const d = new Date(); d.setDate(d.getDate() - i);
            const ds = d.toISOString().split('T')[0];
            const data = history[ds] || {};
            let daySum = 0;
            Object.keys(data).forEach(pid => {
                const m = data[pid];
                daySum += m;
                const p = projects.find(x=>x.id===pid);
                if(p) dist[p.prio > 3 ? 4 : p.prio] += m;
            });
            if(daySum > max) max = daySum;
            weekData.push({ day: days[d.getDay()], val: daySum });
        }

        weekData.forEach(d => {
            const h = (d.val / max) * 100;
            const bg = d.val > 480 ? '#4caf50' : '#444';
            cont.innerHTML += `
                <div class="chart-col">
                    <div class="chart-bar" style="height:${h}%; background:${bg}"></div>
                    <span class="chart-day">${d.day}</span>
                </div>`;
        });

        const distCont = document.getElementById('prio-breakdown');
        distCont.innerHTML = '';
        const totalW = Object.values(dist).reduce((a,b)=>a+b,0);
        const configs = [
            { id:1, label:'Tung (P1)', grad:'var(--p1-grad)' },
            { id:2, label:'Balans (P2)', grad:'var(--p2-grad)' },
            { id:3, label:'Grund (P3)', grad:'var(--p3-grad)' },
            { id:4, label:'Framtid', grad:'var(--p46-grad)' }
        ];

        configs.forEach(c => {
            const val = dist[c.id];
            const pct = totalW > 0 ? Math.round((val/totalW)*100) : 0;
            distCont.innerHTML += `
                <div class="dist-bar">
                    <div class="dist-label">${c.label}</div>
                    <div class="dist-track">
                        <div class="dist-fill" style="width:${pct}%; background:${c.grad}">${pct > 10 ? formatTime(val) : ''}</div>
                    </div>
                    <div style="font-size:0.75rem; font-weight:bold; width:35px;">${pct}%</div>
                </div>`;
        });
    }

    function formatTime(m) { return m >= 60 ? (m/60).toFixed(1) + 'h' : m + 'm'; }
    function formatTimeShort(m) { return m >= 60 ? Math.round(m/60) + 'h' : m + 'm'; }
    
    function setFilter(mode, btn) {
        filterMode = mode;
        document.querySelectorAll('.filter-pill').forEach(el=>el.classList.remove('active'));
        btn.classList.add('active');
        render();
    }
    
    function switchView(v, btn) {
        document.querySelectorAll('.view-section').forEach(el=>el.classList.remove('active'));
        document.getElementById(`view-${v}`).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(el=>el.classList.remove('active'));
        btn.classList.add('active');
        if(v==='stats') renderStats();
    }
    
    function triggerConfetti() {
        const c = document.getElementById('confetti');
        const ctx = c.getContext('2d');
        c.width = window.innerWidth; c.height = window.innerHeight;
        let p = [];
        for(let i=0; i<100; i++) p.push({ x: c.width/2, y: c.height/2, vx: (Math.random()-0.5)*20, vy: (Math.random()-0.5)*20, color: `hsl(${Math.random()*360},100%,50%)`, life: 100 });
        function step() {
            ctx.clearRect(0,0,c.width,c.height);
            p.forEach((k,i)=>{ k.x+=k.vx; k.y+=k.vy; k.vy+=0.5; k.life--; ctx.fillStyle=k.color; ctx.fillRect(k.x,k.y,5,5); if(k.life<0)p.splice(i,1); });
            if(p.length) requestAnimationFrame(step);
        }
        step();
    }
    
    function exportData() {
        const a = document.createElement('a');
        a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({history, sessions, undoStack}));
        a.download = "khalifa_backup.json";
        a.click();
    }
    function importData(inp) {
        const r = new FileReader();
        r.onload = e => { 
            const d = JSON.parse(e.target.result);
            if(d.history) history = d.history;
            if(d.sessions) sessions = d.sessions;
            if(d.undoStack) undoStack = d.undoStack;
            saveState(); alert("Klart!"); render(); 
        };
        r.readAsText(inp.files[0]);
    }

    // INIT
    render();
</script>
</body>
</html>
