<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#050505">
    <title>Khalifa Architect V8</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg: #050505;
            --card-bg: #141414;
            --text: #fff;
            --muted: #888;
            
            /* GRADIENTS */
            --p1-grad: linear-gradient(135deg, #d32f2f, #ef5350);
            --p2-grad: linear-gradient(135deg, #f57c00, #ffb74d);
            --p3-grad: linear-gradient(135deg, #1976d2, #42a5f5);
            --p46-grad: linear-gradient(135deg, #7b1fa2, #ba68c8);
            
            --gold: #ffd700;
            --nav-height: 80px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 0;
            padding-top: 140px; 
            padding-bottom: 120px;
            overscroll-behavior-y: none;
        }

        /* --- HEADER --- */
        .fixed-header {
            position: fixed; top: 0; left: 0; right: 0;
            background: rgba(5,5,5,0.98); z-index: 100;
            border-bottom: 1px solid #222;
        }
        
        .top-deck {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; height: 90px;
        }

        .clock h1 { margin: 0; font-size: 2rem; font-weight: 800; letter-spacing: -1px; }
        .clock p { margin: 0; font-size: 0.7rem; color: var(--muted); text-transform: uppercase; font-weight: 700; letter-spacing: 2px; }

        /* FILTER TABS */
        .filter-bar {
            display: flex; gap: 10px; padding: 0 20px 15px 20px;
            overflow-x: auto;
        }
        .filter-pill {
            background: #222; border: 1px solid #333; color: #888;
            padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;
            white-space: nowrap; transition: all 0.2s;
        }
        .filter-pill.active { background: #fff; color: #000; }

        /* --- DASHBOARD SUMMARY CARD --- */
        .summary-card {
            background: linear-gradient(180deg, #1a1a1a, #111);
            margin: 20px; padding: 15px; border-radius: 16px; border: 1px solid #2a2a2a;
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
        }
        .sum-item { text-align: center; }
        .sum-val { font-size: 1.5rem; font-weight: 800; display: block; }
        .sum-label { font-size: 0.7rem; color: #666; text-transform: uppercase; }
        .progress-total { grid-column: span 2; background: #222; height: 6px; border-radius: 3px; overflow: hidden; margin-top: 5px; }
        .progress-fill-total { height: 100%; background: var(--gold); width: 0%; transition: width 0.5s; }

        /* --- TASK CARDS --- */
        .zone-label {
            margin: 30px 20px 10px 20px; font-size: 0.75rem; font-weight: 800; 
            color: #555; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 10px;
        }
        .zone-line { flex-grow: 1; height: 1px; background: #222; }

        .task-card {
            background: var(--card-bg); margin: 0 20px 15px 20px; padding: 18px;
            border-radius: 16px; border: 1px solid #222;
            position: relative; overflow: hidden; transition: transform 0.1s;
        }
        .task-card:active { transform: scale(0.98); }

        /* PRIO 1 HERO */
        .prio-1 {
            background: linear-gradient(145deg, #1e0a0a 0%, #0a0a0a 100%);
            border: 1px solid #4a1a1a;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .prio-1-mark { position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--p1-grad); }

        /* STATES */
        .recording { border-color: #ef5350; background: #2a0e0e; }
        .paused { border-color: #ffb74d; background: #2a1e0e; animation: pulseYellow 2s infinite; }
        .done { border-color: rgba(255, 215, 0, 0.2); }
        .done .task-title { color: var(--gold); }

        @keyframes pulseYellow { 0% { border-color: #ffb74d; } 50% { border-color: #664a1f; } 100% { border-color: #ffb74d; } }

        /* CARD CONTENT */
        .card-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .task-title { font-size: 1rem; font-weight: 700; display: block; }
        .task-meta { font-size: 0.75rem; color: #666; margin-top: 2px; display: flex; gap: 8px; }
        
        /* CONTROLS */
        .control-group { display: flex; align-items: center; gap: 10px; }
        
        .timer-badge { 
            font-family: monospace; font-size: 0.9rem; color: #666; background: #000; 
            padding: 6px 10px; border-radius: 6px; min-width: 65px; text-align: center; 
        }
        .recording .timer-badge { color: #fff; background: #d32f2f; }
        .paused .timer-badge { color: #000; background: #ffb74d; }

        .btn-main {
            width: 50px; height: 50px; border-radius: 50%; border: none;
            background: #252525; color: #fff; font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: all 0.2s;
        }
        .btn-stop {
            width: 35px; height: 35px; border-radius: 50%; border: none;
            background: #222; color: #ef5350; font-size: 0.9rem;
            display: none; align-items: center; justify-content: center;
        }

        /* Active State Controls */
        .recording .btn-main { background: var(--p1-grad); }
        .recording .btn-stop { display: flex; }
        .paused .btn-main { background: #ffb74d; color: #000; animation: none; }
        .paused .btn-stop { display: flex; }

        /* Progress Bar inside Card */
        .card-progress-bg { height: 4px; background: #222; border-radius: 2px; overflow: hidden; margin-top: 10px; }
        .card-progress-fill { height: 100%; background: #444; width: 0%; transition: width 0.3s; }
        .prio-1 .card-progress-fill { background: var(--p1-grad); }
        .done .card-progress-fill { background: var(--gold); }

        /* --- STATS VIEW --- */
        .view-section { display: none; padding: 20px; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }
        
        .stat-row { display: flex; align-items: center; margin-bottom: 12px; font-size: 0.8rem; }
        .stat-label { width: 40px; color: #888; }
        .stat-bar-bg { flex-grow: 1; height: 20px; background: #222; border-radius: 4px; margin: 0 10px; position: relative; }
        .stat-bar-fill { height: 100%; background: #444; border-radius: 4px; min-width: 2px; }
        .stat-val { width: 50px; text-align: right; font-weight: bold; }

        /* --- TOAST (UNDO) --- */
        .toast {
            position: fixed; bottom: 90px; left: 20px; right: 20px;
            background: #222; border: 1px solid #333; color: #fff;
            padding: 15px; border-radius: 10px;
            display: flex; justify-content: space-between; align-items: center;
            transform: translateY(150%); transition: transform 0.3s; z-index: 200;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .toast.show { transform: translateY(0); }
        .btn-undo { background: none; border: 1px solid #555; color: #fff; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; }

        /* --- BOTTOM NAV --- */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; right: 0; height: 80px;
            background: #000; border-top: 1px solid #1a1a1a;
            display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; /* +1 f√∂r Settings */
            z-index: 150;
        }
        .nav-btn {
            background: none; border: none; color: #555;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 0.65rem; gap: 4px;
        }
        .nav-btn.active { color: #fff; }
        .nav-btn i { font-size: 1.2rem; }

        /* MODAL (Export) */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:300; align-items:center; justify-content:center; }
        .modal-content { background:#222; padding:20px; border-radius:15px; width:85%; text-align:center; }
        .btn-full { width:100%; padding:15px; background:#333; border:none; color:#fff; border-radius:8px; margin-bottom:10px; font-weight:bold; }

        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }

    </style>
</head>
<body>

    <!-- HEADER -->
    <div class="fixed-header">
        <div class="top-deck">
            <div class="clock">
                <h1 id="clock">07:00</h1>
                <p>THE ARCHITECT V8</p>
            </div>
            <!-- Ringar borttagna f√∂r renare look, ersatta av Summary Card -->
        </div>
        <div class="filter-bar">
            <div class="filter-pill active" onclick="setFilter('today', this)">IDAG</div>
            <div class="filter-pill" onclick="setFilter('all', this)">ALLA PROJEKT</div>
            <div class="filter-pill" onclick="setFilter('todo', this)">G√ñRA</div>
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <div id="view-today" class="view-section active">
        <!-- Summary Card -->
        <div class="summary-card">
            <div class="sum-item">
                <span class="sum-val" id="sum-time">0h 0m</span>
                <span class="sum-label">Jobbat Idag</span>
            </div>
            <div class="sum-item">
                <span class="sum-val" id="sum-prio1">0%</span>
                <span class="sum-label">Prio 1 M√•l</span>
            </div>
            <div class="progress-total">
                <div class="progress-fill-total" id="daily-bar"></div>
            </div>
        </div>

        <div id="task-list"></div>
    </div>

    <!-- STATS VIEW -->
    <div id="view-stats" class="view-section">
        <h2>Veckans Analys</h2>
        <div id="week-chart" style="margin-top:20px;"></div>
        
        <h2 style="margin-top:40px;">F√∂rdelning</h2>
        <div id="dist-chart"></div>
    </div>

    <!-- SETTINGS VIEW -->
    <div id="view-settings" class="view-section">
        <h2>Data & S√§kerhet</h2>
        <button class="btn-full" onclick="exportData()"><i class="fas fa-download"></i> Exportera Backup</button>
        <button class="btn-full" onclick="document.getElementById('file-input').click()"><i class="fas fa-upload"></i> Importera Backup</button>
        <input type="file" id="file-input" style="display:none" onchange="importData(this)">
        <p style="color:#666; font-size:0.8rem; text-align:center; margin-top:20px;">V8.0 - LocalStorage System</p>
    </div>

    <!-- UNDO TOAST -->
    <div id="toast" class="toast">
        <span><i class="fas fa-save"></i> Tid sparad.</span>
        <button class="btn-undo" onclick="undoLast()">√ÖNGRA</button>
    </div>

    <!-- BOTTOM NAV -->
    <div class="nav-bar">
        <button class="nav-btn active" onclick="switchView('today', this)"><i class="fas fa-layer-group"></i>FOKUS</button>
        <button class="nav-btn" onclick="switchView('stats', this)"><i class="fas fa-chart-pie"></i>ANALYS</button>
        <button class="nav-btn" onclick="switchView('settings', this)"><i class="fas fa-cog"></i>INST.</button>
    </div>

<script>
    // --- KONFIGURATION ---
    const projects = [
        { id: 'yt_long', title: 'YouTube L√•ng', icon: 'üìπ', prio: 1, target: 120 },
        { id: 'yt_short', title: 'YouTube Kort', icon: 'üì±', prio: 1, target: 60 },
        { id: 'social', title: 'Social Media', icon: 'üí¨', prio: 2, target: 45 },
        { id: 'fam_act', title: 'Familj & Lek', icon: 'üé≤', prio: 2, target: 60 },
        { id: 'azzah', title: 'Azzah Tid', icon: '‚ù§Ô∏è', prio: 2, target: 60 },
        { id: 'kids', title: 'Barn 1-mot-1', icon: 'üë∂', prio: 2, target: 30 },
        { id: 'health', title: 'H√§lsa', icon: 'üåø', prio: 2, target: 45 },
        { id: 'prayer', title: 'B√∂n & Adhkar', icon: 'üìø', prio: 3, target: 30 },
        { id: 'meals', title: 'Mat & Hus', icon: 'üè†', prio: 3, target: 45 },
        { id: 'learning', title: 'L√§rande', icon: 'üß†', prio: 3, target: 30 },
        { id: 'thriller', title: 'Bok: Deckare', icon: 'üïµÔ∏è‚Äç‚ôÇÔ∏è', prio: 4, target: 30 },
        { id: 'biz', title: 'Business', icon: 'üíº', prio: 4, target: 30 },
        { id: 'prep', title: 'Meal Prep', icon: 'ü•¶', prio: 4, target: 60 },
        { id: 'coach', title: 'Coaching', icon: 'üéì', prio: 5, target: 30 },
        { id: 'strategy', title: 'Strategi', icon: '‚ôüÔ∏è', prio: 6, target: 30 },
        { id: 'ai', title: 'AI & Tech', icon: 'ü§ñ', prio: 6, target: 30 }
    ];

    // --- STATE MANAGER ---
    let history = JSON.parse(localStorage.getItem('khalifa_v8_hist')) || {};
    // ActiveTask Struktur: { id: 'yt_long', start: timestamp, accumulated: ms, state: 'running'|'paused' }
    let activeTask = JSON.parse(localStorage.getItem('khalifa_v8_active')) || null;
    let lastLog = null; // F√∂r Undo
    let filterMode = 'today';

    // --- HELPER FUNCTIONS ---
    function getTodayStr() { return new Date().toISOString().split('T')[0]; }
    function getTodayData() { 
        const d = getTodayStr();
        if(!history[d]) history[d] = {};
        return history[d];
    }
    function saveState() {
        localStorage.setItem('khalifa_v8_hist', JSON.stringify(history));
        localStorage.setItem('khalifa_v8_active', JSON.stringify(activeTask));
    }
    function vibrate(ms) { if(navigator.vibrate) navigator.vibrate(ms); }

    // --- CORE RENDERER ---
    function render() {
        renderDashboard();
        renderSummary();
    }

    function renderDashboard() {
        const list = document.getElementById('task-list');
        list.innerHTML = '';
        const todayData = getTodayData();
        
        // Sortera: Prio 1 f√∂rst
        const sorted = [...projects].sort((a,b) => a.prio - b.prio);
        let lastPrio = 0;

        sorted.forEach(p => {
            // FILTER
            if(filterMode === 'today' && p.prio > 3) return;
            if(filterMode === 'todo' && (todayData[p.id] || 0) >= p.target) return;

            // ZONE HEADERS
            if(p.prio !== lastPrio) {
                let label = "";
                if(p.prio === 1) label = "üî• TUNG ZON";
                else if(p.prio === 2) label = "‚öñÔ∏è BALANS";
                else if(p.prio === 3) label = "‚öìÔ∏è GRUND";
                else label = "üöÄ FRAMTID (Prio 4-6)";
                list.innerHTML += `<div class="zone-label">${label} <div class="zone-line"></div></div>`;
                lastPrio = p.prio;
            }

            // STATE CALCULATION
            const totalMins = todayData[p.id] || 0;
            const isDone = totalMins >= p.target;
            const isActive = activeTask && activeTask.id === p.id;
            const isPaused = isActive && activeTask.state === 'paused';

            // STREAK CALC (Enkel)
            const streak = calculateStreak(p.id);
            const streakHtml = streak > 1 ? `<span style="color:#ff9800; font-size:0.7rem;">üî• ${streak} dagar</span>` : '';

            // PROGRESS BAR
            const progressPct = Math.min(100, (totalMins / p.target) * 100);
            
            // CLASSES
            let classes = 'task-card';
            if(p.prio === 1) classes += ' prio-1';
            if(isActive) classes += ' recording';
            if(isPaused) classes += ' paused';
            if(isDone && !isActive) classes += ' done';

            // ICON & BUTTON
            let btnIcon = '<i class="fas fa-play"></i>';
            if(isActive && !isPaused) btnIcon = '<i class="fas fa-pause"></i>'; // Pause icon when running
            if(isPaused) btnIcon = '<i class="fas fa-play"></i>'; // Play icon when paused

            // TIMER DISPLAY
            let timeDisplay = formatTime(totalMins);
            if(isActive) timeDisplay = "00:00"; // Placeholder, uppdateras av live-loop

            // RENDER HTML
            const html = `
                <div class="${classes}" id="card-${p.id}" 
                     oncontextmenu="return false;" 
                     ontouchstart="handleTouchStart('${p.id}')" 
                     ontouchend="handleTouchEnd()" 
                     onmousedown="handleTouchStart('${p.id}')" 
                     onmouseup="handleTouchEnd()">
                     
                    ${p.prio === 1 ? '<div class="prio-1-mark"></div>' : ''}
                    
                    <div class="card-top">
                        <div style="flex-grow:1;">
                            <span class="task-title">${p.icon} ${p.title}</span>
                            <div class="task-meta">
                                <span>M√•l: ${p.target}m</span>
                                ${streakHtml}
                            </div>
                        </div>
                        <div class="control-group">
                            <div class="timer-badge" id="badge-${p.id}">${timeDisplay}</div>
                            
                            <!-- STOP BUTTON (Endast synlig n√§r aktiv) -->
                            <button class="btn-stop" onclick="stopTask('${p.id}', event)">
                                <i class="fas fa-stop"></i>
                            </button>

                            <!-- MAIN PLAY/PAUSE -->
                            <button class="btn-main" onclick="toggleTask('${p.id}')">
                                ${btnIcon}
                            </button>
                        </div>
                    </div>
                    
                    <div class="card-progress-bg">
                        <div class="card-progress-fill" style="width:${progressPct}%"></div>
                    </div>
                </div>
            `;
            list.innerHTML += html;
        });
    }

    // --- SUMMARY RENDER ---
    function renderSummary() {
        const todayData = getTodayData();
        let totalMins = 0;
        let prio1Goal = 0; 
        let prio1Done = 0;

        projects.forEach(p => {
            const m = todayData[p.id] || 0;
            totalMins += m;
            if(p.prio === 1) {
                prio1Goal += p.target;
                prio1Done += Math.min(p.target, m);
            }
        });

        document.getElementById('sum-time').innerText = formatTime(totalMins);
        
        const p1Pct = prio1Goal > 0 ? Math.round((prio1Done / prio1Goal) * 100) : 0;
        document.getElementById('sum-prio1').innerText = p1Pct + "%";
        
        // Dagligt m√•l 14h (840m) f√∂r baren
        const dayPct = Math.min(100, (totalMins / 840) * 100);
        document.getElementById('daily-bar').style.width = dayPct + "%";
    }

    // --- TIMER LOGIC (V8 ENGINE) ---
    function toggleTask(id) {
        vibrate(20);
        const now = Date.now();

        if (activeTask && activeTask.id === id) {
            // DET √ÑR DEN AKTIVA UPPGIFTEN
            if (activeTask.state === 'running') {
                // PAUSA
                const session = now - activeTask.lastTick;
                activeTask.accumulated += session;
                activeTask.state = 'paused';
                activeTask.lastTick = null; // Stoppa klockan
            } else {
                // FORTS√ÑTT (RESUME)
                activeTask.state = 'running';
                activeTask.lastTick = now;
            }
        } else {
            // NY UPPGIFT
            if (activeTask) autoStop(); // Stoppa gamla f√∂rst
            
            // Starta ny
            activeTask = {
                id: id,
                state: 'running',
                accumulated: 0,
                lastTick: now
            };
        }
        saveState();
        render();
    }

    function stopTask(id, event) {
        if(event) event.stopPropagation(); // F√∂rhindra klick p√• kortet
        vibrate(40);
        autoStop();
        render();
    }

    function autoStop() {
        if(!activeTask) return;
        
        // R√§kna ut sista sessionen om den k√∂rs
        let finalSession = 0;
        if(activeTask.state === 'running') {
            finalSession = Date.now() - activeTask.lastTick;
        }
        
        const totalSessionMs = activeTask.accumulated + finalSession;
        const totalSessionMins = Math.floor(totalSessionMs / 60000);
        
        if(totalSessionMins > 0) {
            commitTime(activeTask.id, totalSessionMins);
        }
        
        activeTask = null;
        saveState();
    }

    function commitTime(id, mins) {
        const d = getTodayStr();
        if(!history[d]) history[d] = {};
        if(!history[d][id]) history[d][id] = 0;
        
        history[d][id] += mins;
        
        // Spara f√∂r Undo
        lastLog = { date: d, id: id, mins: mins };
        showToast();
        saveState();
    }

    // --- LIVE UPDATE LOOP ---
    setInterval(() => {
        if(activeTask) {
            const badge = document.getElementById(`badge-${activeTask.id}`);
            if(badge) {
                let currentMs = activeTask.accumulated;
                if(activeTask.state === 'running') {
                    currentMs += (Date.now() - activeTask.lastTick);
                }
                
                // Formatera MM:SS
                const totalSec = Math.floor(currentMs / 1000);
                const m = Math.floor(totalSec / 60);
                const s = totalSec % 60;
                
                badge.innerText = `${m}:${String(s).padStart(2,'0')}`;
                
                if(activeTask.state === 'paused') {
                    badge.innerText = "PAUS";
                }
            }
        }
        
        // Klocka
        const d = new Date();
        document.getElementById('clock').innerText = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        
    }, 1000);

    // --- LONG PRESS (+5 MIN) ---
    let touchTimer;
    function handleTouchStart(id) {
        touchTimer = setTimeout(() => {
            vibrate(100);
            commitTime(id, 5); // L√§gg till 5 min
            alert(`+5 min tillagt p√• ${projects.find(p=>p.id===id).title}`);
            render();
        }, 800); // 800ms hold
    }
    function handleTouchEnd() { clearTimeout(touchTimer); }

    // --- UNDO SYSTEM ---
    function showToast() {
        const t = document.getElementById('toast');
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 5000);
    }
    function undoLast() {
        if(lastLog) {
            history[lastLog.date][lastLog.id] -= lastLog.mins;
            lastLog = null;
            document.getElementById('toast').classList.remove('show');
            saveState();
            render();
            alert("Tiden √•ngrad.");
        }
    }

    // --- STATS ENGINE (SVG GRAPHS) ---
    function renderStats() {
        // Vecka Chart
        const wContainer = document.getElementById('week-chart');
        wContainer.innerHTML = '';
        const days = ['S√∂n','M√•n','Tis','Ons','Tor','Fre','L√∂r'];
        
        let maxVal = 1;
        let weekData = [];
        
        for(let i=6; i>=0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            const dStr = d.toISOString().split('T')[0];
            const dayData = history[dStr] || {};
            const total = Object.values(dayData).reduce((a,b)=>a+b,0);
            if(total > maxVal) maxVal = total;
            weekData.push({ day: days[d.getDay()], val: total });
        }

        weekData.forEach(d => {
            const h = (d.val / maxVal) * 100; // H√∂jd i %
            const color = d.val > 480 ? '#4caf50' : '#444'; // Gr√∂n om > 8h
            wContainer.innerHTML += `
                <div style="display:flex; flex-direction:column; align-items:center; width:12%;">
                    <div style="height:100px; width:100%; display:flex; align-items:flex-end; background:#222; border-radius:4px;">
                        <div style="width:100%; background:${color}; height:${h}%; border-radius:4px;"></div>
                    </div>
                    <span style="font-size:0.6rem; color:#666; margin-top:5px;">${d.day}</span>
                </div>
            `;
        });
        wContainer.style.display = "flex";
        wContainer.style.justifyContent = "space-between";
    }

    // --- UTILS & EXPORT ---
    function setFilter(mode, btn) {
        filterMode = mode;
        document.querySelectorAll('.filter-pill').forEach(el => el.classList.remove('active'));
        btn.classList.add('active');
        render();
    }

    function switchView(view, btn) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${view}`).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        btn.classList.add('active');
        if(view === 'stats') renderStats();
    }

    function formatTime(m) { return m >= 60 ? (m/60).toFixed(1) + 'h' : m + 'm'; }
    
    function calculateStreak(id) {
        let streak = 0;
        // Kolla bak√•t 30 dagar
        for(let i=0; i<30; i++) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            const dStr = d.toISOString().split('T')[0];
            if(history[dStr] && history[dStr][id] > 10) streak++; // Minst 10 min f√∂r streak
            else if(i > 0) break; // Avbruten streak (men till√•t dagens nolla om man inte b√∂rjat √§n)
        }
        return streak;
    }

    function exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(history));
        const anchor = document.createElement('a');
        anchor.setAttribute("href", dataStr);
        anchor.setAttribute("download", "khalifa_backup.json");
        document.body.appendChild(anchor);
        anchor.click();
        anchor.remove();
    }

    function importData(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                history = JSON.parse(e.target.result);
                saveState();
                alert("Import lyckades!");
                render();
            } catch(err) { alert("Fel p√• filen!"); }
        };
        reader.readAsText(file);
    }

    // INIT
    render();

</script>
</body>
</html>
